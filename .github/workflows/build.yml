name: Build & Test CI

on:  
    push:    
      branches: [ main ]  
    pull_request:    
      branches: [ main ]

jobs:  
    build:    
        runs-on: macos-latest 

        steps:    
        - uses: actions/checkout@v3    
        
        - name: Build for iOS simulator (iPhone 14) üì±     
          run: |
            set -o pipefail && env NSUnbufferedIO=YES \
              xcodebuild build-for-testing \
                -scheme "CoreUIKit" \
                -destination "platform=iOS Simulator,OS=latest,name=iPhone 14"    
        
        - name: Run iOS tests üß™     
          run: |
            set -o pipefail && env NSUnbufferedIO=YES \
              xcodebuild test-without-building \
                -scheme "CoreUIKitTests" \
                -destination "platform=iOS Simulator,OS=latest,name=iPhone 14"    


    # Deploy job
    deploy:
        runs-on: macos-latest
        
        # Add a dependency to the build job
        needs: build

        # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
        permissions:
            contents: read
            pages: write      # to deploy to Pages
            id-token: write   # to verify the deployment originates from an appropriate source

        # Allow one concurrent deployment
        concurrency:
          group: "pages"
          cancel-in-progress: true

        # Deploy to the github-pages environment
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Build documentation ‚öôÔ∏è     
              run: |
                set -o pipefail && env NSUnbufferedIO=YES \
                  xcodebuild docbuild \
                    -derivedDataPath /tmp/doccgen \
                    -scheme "CoreUIKit" \
                    -destination 'generic/platform=iOS'    
        
            - name: Generate documentation üõ†Ô∏è üìÑ     
              run: |
                set -o pipefail && env NSUnbufferedIO=YES \
                  $(xcrun --find docc) process-archive \
                    transform-for-static-hosting /tmp/doccgen/Build/Products/Debug-iphonesimulator/CoreUIKit.doccarchive \
                    --output-path docs \
                    --hosting-base-path CoreUIKit

            - name: Upload Docs to doc folder üóÇÔ∏è
              uses: actions/upload-pages-artifact@v1
              with:
                path: 'docs'
            
            - name: Deploy docs to GitHub Pages üöÄ
              id: deployment
              uses: actions/deploy-pages@v1
